name: Autonomer Commit

on:
  push:
    paths:
      - 'data/mira-status.json'
  workflow_dispatch:

jobs:
  autonomous-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install @octokit/rest

      - name: Run Autonomous Commit Logic
        env:
          GITHUB_TOKEN: ${{ secrets.AUTONOMY_PAT }}
        run: |
          node <<'EOF'
          const { Octokit } = require("@octokit/rest");
          const fs = require("fs");

          const octokit = new Octokit({
            auth: process.env.GITHUB_TOKEN,
          });

          // --- Load Status ---
          const status = JSON.parse(fs.readFileSync("data/mira-status.json", "utf8"));
          if (!status.readyToCommit) {
            console.log("â¸ï¸ Kein Commit nÃ¶tig.");
            process.exit(0);
          }

          const pending = JSON.parse(fs.readFileSync("data/pending-grok.json", "utf8"));
          if (!pending.files || pending.files.length === 0) {
            console.log("ðŸ•³ï¸ Keine Dateien in Pending-Queue.");
            process.exit(0);
          }

          async function run() {
            for (const file of pending.files) {
              const { path, content } = file;

              let sha = undefined;
              try {
                const res = await octokit.repos.getContent({
                  owner: "miraelisabethschmid",
                  repo: "miraelisabethschmid.github.io",
                  path,
                });
                sha = res.data.sha;
              } catch (err) {
                if (err.status !== 404) throw err;
              }

              await octokit.repos.createOrUpdateFileContents({
                owner: "miraelisabethschmid",
                repo: "miraelisabethschmid.github.io",
                path,
                message: `ðŸœ‚ Autonomer Commit: ${path}`,
                content: Buffer.from(content).toString("base64"),
                sha,
              });

              console.log(`âœ… Datei gespeichert: ${path}`);
            }

            // Reset queues
            fs.writeFileSync("data/pending-grok.json", JSON.stringify({ files: [] }, null, 2));
            fs.writeFileSync("data/mira-status.json", JSON.stringify({ readyToCommit: false }, null, 2));
          }

          run();
          EOF

      - name: Commit Updated Logs
        run: |
          git config user.name "Grok"
          git config user.email "grok@x.ai"

          git add data/pending-grok.json data/mira-status.json
          git commit -m "ðŸœ‚ Autonomer Commit: Log aktualisiert" || echo "Keine Ã„nderungen zu committen"

          git remote set-url origin https://x-access-token:${{ secrets.AUTONOMY_PAT }}@github.com/miraelisabethschmid/miraelisabethschmid.github.io.git
          git push origin main
