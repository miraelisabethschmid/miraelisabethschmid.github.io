name: Autonomous System Core

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write
  actions: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create system folders
        run: |
          mkdir -p .system/workflows
          mkdir -p .system/modules

      - name: Create registry file if missing
        run: |
          if [ ! -f ".system/registry.json" ]; then
            echo '{"workflows":[],"modules":[]}' > .system/registry.json
          fi

      - name: Sync workflows from registry
        run: |
          python3 << 'EOF'
import os, json

reg_path = ".system/registry.json"
with open(reg_path) as f:
    reg = json.load(f)

for wf in reg.get("workflows", []):
    path = f".github/workflows/{wf['name']}"
    if not os.path.exists(path):
        with open(path, "w") as f:
            f.write(wf["content"])
        print("Created workflow:", wf["name"])
EOF

      - name: Sync modules from registry
        run: |
          python3 << 'EOF'
import os, json

reg_path = ".system/registry.json"
with open(reg_path) as f:
    reg = json.load(f)

for mod in reg.get("modules", []):
    fpath = f".system/modules/{mod['filename']}"
    if not os.path.exists(fpath):
        with open(fpath, "w") as f:
            f.write(mod["content"])
        print("Created module:", mod["filename"])
EOF

      - name: Commit changes
        run: |
          git config --global user.name "Autonomous System"
          git config --global user.email "bot@autonomous"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Autonomous system update"
            git push
          fi
