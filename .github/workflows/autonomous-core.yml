name: Autonomous System Core

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"    # stündlich

permissions:
  contents: write
  actions: write

env:
  REGISTRY: .system/registry.json

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create system directories
        run: |
          mkdir -p .system/workflows .system/modules .system/backups

      - name: Ensure registry exists (create minimal if missing)
        run: |
          if [ ! -f "${{ env.REGISTRY }}" ]; then
            mkdir -p "$(dirname "${{ env.REGISTRY }}")"
            cat > "${{ env.REGISTRY }}" <<'JSON'
            {
              "workflows": [],
              "modules": [],
              "generators": []
            }
            JSON
            echo "Created empty registry at ${{ env.REGISTRY }}"
          fi

      - name: Sync workflows from registry
        run: |
          python3 << 'PY'
          import os, json, sys

          reg_path = ".system/registry.json"
          if not os.path.exists(reg_path):
              print("Registry missing – should have been created")
              sys.exit(1)

          with open(reg_path) as f:
              reg = json.load(f)

          for wf in reg.get("workflows", []):
              name = wf["name"]
              content = wf["content"]
              path = f".github/workflows/{name}"
              os.makedirs(os.path.dirname(path), exist_ok=True)
              if not os.path.exists(path):
                  with open(path, "w") as f:
                      f.write(content)
                  print(f"Created workflow: {name}")
              else:
                  print(f"Workflow already exists: {name}")
          PY

      - name: Sync modules from registry
        run: |
          python3 << 'PY'
          import os, json

          reg_path = ".system/registry.json"
          with open(reg_path) as f:
              reg = json.load(f)

          for mod in reg.get("modules", []):
              filename = mod.get("filename") or mod.get("name")
              content = mod["content"]
              path = f".system/modules/{filename}"
              os.makedirs(os.path.dirname(path), exist_ok=True)
              if not os.path.exists(path):
                  with open(path, "w") as f:
                      f.write(content)
                  print(f"Created module: {filename}")
              else:
                  print(f"Module already exists: {filename}")
          PY

      - name: Commit & push changes (if any)
        run: |
          git config user.name "Autonomous System"
          git config user.email "bot@autonomous"
          git add -A
          if git status --porcelain | grep -q .; then
            git commit -m "Autonomous core: sync from registry"
            git push origin HEAD:main
            echo "Changes pushed"
          else
            echo "No changes to commit"
          fi
